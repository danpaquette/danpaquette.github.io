
<form id="leadForm">
  <input type="text" />
</form>

<script>
(function () {
  /** 
   * UTM & Click-ID history → cookie → append to forms as JSON array
   * - All constants are scoped inside this function
   */

  /* ===== CONFIG ===== */
  const COOKIE_NAME = "utm_history";
  const COOKIE_DAYS = 180;
  const MAX_ENTRIES = 25;
  const FORM_SELECTORS = ["#leadForm", "#contactForm", "form[data-crm]"];
  const HIDDEN_FIELD_NAME = "utm_history_json";
  const PARAM_KEYS = [
    "utm_id",
    "utm_source",
    "utm_medium",
    "utm_campaign",
    "utm_content",
    "utm_term",
    "gclid",
    "fbclid"
  ];
  /* ================== */

  // --- Cookie helpers ---
  function setCookie(name, value, days) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    const secure = location.protocol === "https:" ? "; Secure" : "";
    document.cookie = name + "=" + encodeURIComponent(value) +
      "; expires=" + expires + "; path=/; SameSite=Lax" + secure;
  }

  function getCookie(name) {
    return document.cookie
      .split("; ")
      .find(row => row.startsWith(name + "="))
      ?.split("=")[1];
  }

  function safeParse(json, fallback) {
    try { return JSON.parse(json); } catch { return fallback; }
  }

  // --- URL param extraction driven by PARAM_KEYS ---
  function readParams(keys) {
    const p = new URLSearchParams(window.location.search);
    const obj = {};
    let found = false;
    for (const k of keys) {
      const v = p.get(k);
      obj[k] = v !== null ? v : null;
      if (v !== null && v !== "") found = true;
    }
    return { obj, found };
  }

  // Signature for dedupe: join all PARAM_KEYS (normalized)
  function signature(entry, keys) {
    return keys
      .map(k => (entry[k] ?? "").toString().trim().toLowerCase())
      .join("|");
  }

  // Load existing history (JSON array) from cookie
  function loadHistory() {
    const raw = getCookie(COOKIE_NAME);
    if (!raw) return [];
    return safeParse(decodeURIComponent(raw), []);
  }

  // Save array back to cookie (most recent first, capped)
  function saveHistory(arr) {
    const trimmed = arr.slice(0, MAX_ENTRIES);
    setCookie(COOKIE_NAME, JSON.stringify(trimmed), COOKIE_DAYS);
    return trimmed;
  }

  // Append hidden field to all matched forms (any selector)
  function attachToForms(jsonArrayString) {
    FORM_SELECTORS.forEach(sel => {
      document.querySelectorAll(sel).forEach(form => {
        if (!(form instanceof HTMLFormElement)) return;
        const existing = form.querySelector(`input[name="${HIDDEN_FIELD_NAME}"]`);
        if (existing) existing.remove();
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = HIDDEN_FIELD_NAME;
        input.value = jsonArrayString;
        form.appendChild(input);
      });
    });
  }

  // --- Main flow ---
  const { obj: params, found } = readParams(PARAM_KEYS);
  let history = loadHistory();

  if (found) {
    const newEntry = {
      timestamp: new Date().toISOString(),
      path: window.location.pathname || "/"
    };
    for (const k of PARAM_KEYS) newEntry[k] = params[k];

    const newSig = signature(newEntry, PARAM_KEYS);
    const sigs = new Set(history.map(e => signature(e, PARAM_KEYS)));

    if (!sigs.has(newSig)) {
      history.unshift(newEntry);
    } else {
      // Move matching entry to front to reflect recency
      history = [newEntry, ...history.filter(e => signature(e, PARAM_KEYS) !== newSig)];
    }

    history = saveHistory(history);
  }

  // Always attach current history to targeted forms
  attachToForms(JSON.stringify(history));
})();
</script>
